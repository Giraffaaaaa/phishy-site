<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phishy - Blog</title>
    <style>
        /* Stili base (aggiungi il tuo CSS completo qui) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            width: 90%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .meme-post {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .comments-section {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        
        .comment-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .comment-form input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .comment-form button {
            padding: 10px 20px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .comment {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .comment-avatar {
            width: 40px;
            height: 40px;
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .error-message {
            color: #f44336;
            padding: 10px;
            background: #ffebee;
            border-radius: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    <header>
        <div class="container">
            <div class="header-content">
                <a href="index.html" class="logo">
                    <span>Phishy - Blog</span>
                </a>
                <button class="mobile-menu-btn">â˜°</button>
                <nav>
                    <a href="index.html">Home</a>
                    <a href="menu-comandi.html">Menu dei Comandi</a>
                    <a href="funzioni-principali.html">Funzioni Principali</a>
                    <a href="chi-siamo.html">Chi Siamo</a>
                </nav>
            </div>
        </div>
    </header>

    <div class="container main-content">
        <div class="hero-section">
            <h1>Il Blog di Phishy</h1>
            <p>Leggi i post pubblicati e commenta con il tuo nome!</p>
        </div>

        <div id="post-container" class="meme-container">
            <!-- I post verranno caricati dinamicamente -->
        </div>
    </div>

    <footer>
        <div class="container">
            <p>&copy; 2025 Phishy - Blog. Tutti i diritti riservati.</p>
        </div>
    </footer>

    <script>
        document.querySelector('.mobile-menu-btn').addEventListener('click', function() {
            document.querySelector('nav').classList.toggle('active');
        });

        const fileNames = [
            "post1.mp4",
            "post2-1.mp4",
            "post2-2.mp4",
            "post3.mp4",
            "post4-1.mp4",
            "post4-2.mp4",
            "post5-1.mp4",
            "post5-2.mp4",
            "post6.mp4",
            "post7-1.mp4",
            "post7-2.mp4",
            "post8.mp4",
            "post9.mp4",
            "post10.mp4",
        ];

        const container = document.getElementById('post-container');
        const API_BASE_URL = window.location.origin; // Base URL automatico

        // Funzione per mostrare errori nell'UI
        function showError(container, message) {
            // Rimuovi errori precedenti
            const oldError = container.querySelector('.error-message');
            if (oldError) oldError.remove();
            
            const errorEl = document.createElement('div');
            errorEl.className = 'error-message';
            errorEl.textContent = message;
            container.appendChild(errorEl);
        }

        // Funzione per aggiungere commenti all'UI
        function addCommentToUI(name, text, container) {
            const commentEl = document.createElement('div');
            commentEl.className = 'comment';
            commentEl.innerHTML = `
                <div class="comment-avatar">${name[0].toUpperCase()}</div>
                <div class="comment-content">
                    <div class="comment-author">${name}</div>
                    <div class="comment-text">${text}</div>
                </div>
            `;
            container.appendChild(commentEl);
        }

        // Funzione per caricare i commenti esistenti
        async function loadComments(postIndex, commentsList) {
            try {
                const res = await fetch(`${API_BASE_URL}/api/comments/${postIndex}`);
                if (!res.ok) throw new Error('Errore nel caricamento');
                
                const comments = await res.json();
                commentsList.innerHTML = ''; // Svuota la lista
                
                if (comments.length === 0) {
                    commentsList.innerHTML = '<p>Nessun commento ancora</p>';
                    return;
                }
                
                comments.forEach(({ name, text }) => {
                    addCommentToUI(name, text, commentsList);
                });
            } catch (err) {
                console.error('Errore caricando i commenti:', err);
                showError(commentsList, 'Errore nel caricamento dei commenti');
            }
        }

        // Creazione dei post
        fileNames.forEach((fileName, index) => {
            const extension = fileName.split('.').pop().toLowerCase();
            const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(extension);
            const isVideo = ['mp4', 'webm', 'ogg'].includes(extension);

            const postEl = document.createElement('div');
            postEl.className = 'meme-post';
            postEl.innerHTML = `
                <div class="post-header">
                    <div class="creator-avatar">P</div>
                    <div class="creator-info">
                        <div class="creator-name">Phishy Admin</div>
                        <div class="post-date">${new Date().toLocaleDateString('it-IT')}</div>
                    </div>
                </div>
                <div class="post-content">
                    <div class="badge" style="margin-bottom:10px;font-weight:bold;color:#FFD700;">
                        ${isImage ? 'ðŸ“· Foto' : isVideo ? 'ðŸŽ¥ Video' : ''}
                    </div>
                    <div class="post-caption">Post #${index + 1}</div>
                    ${isImage ? `<img src="posts/${fileName}" alt="Post ${index + 1}" style="width:100%;border-radius:10px;margin-bottom:20px;">` : isVideo ? `
                    <video controls style="width:100%;border-radius:10px;margin-bottom:20px;">
                        <source src="posts/${fileName}" type="video/${extension}">
                        Il tuo browser non supporta il tag video.
                    </video>` : ''}
                </div>
                <div class="comments-section">
                    <form class="comment-form" data-post-index="${index}">
                        <input type="text" class="comment-name" placeholder="Nome" required>
                        <input type="text" class="comment-input" placeholder="Scrivi un commento..." required>
                        <button type="submit" class="comment-submit">Invia</button>
                    </form>
                    <div class="comments-list"></div>
                </div>
            `;
            container.appendChild(postEl);

            const form = postEl.querySelector('.comment-form');
            const commentsList = postEl.querySelector('.comments-list');

            // Carica i commenti iniziali
            loadComments(index, commentsList);

            // Gestione invio commenti
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const nameInput = form.querySelector('.comment-name');
                const textInput = form.querySelector('.comment-input');
                const name = nameInput.value.trim();
                const text = textInput.value.trim();
                
                if (!name || !text) {
                    showError(form, 'Inserisci nome e commento');
                    return;
                }

                try {
                    const response = await fetch(`${API_BASE_URL}/api/comments`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            postIndex: index, 
                            name, 
                            text 
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Errore nel salvataggio');
                    }

                    // Ricarica i commenti dal server
                    await loadComments(index, commentsList);
                    
                    // Reset del form
                    nameInput.value = '';
                    textInput.value = '';
                    
                } catch (err) {
                    console.error('Errore salvando il commento:', err);
                    showError(form, err.message || 'Errore nel salvataggio del commento');
                }
            });
        });
    </script>
</body>
</html>
